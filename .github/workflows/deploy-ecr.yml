name: Deploy Spring Boot to EC2

on:
  push:
    branches: [back/production]

# ë™ì¼í•œ ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ë©´ ì´ì „ ì›Œí¬í”Œë¡œìš° ì·¨ì†Œ
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      # 3. Gradle ìºì‹œ
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: Build Spring Boot App
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      # 5. AWS ìê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 6. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build & Push Docker image to ECR
        run: |
          echo "Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

          echo "Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "âœ… Image pushed successfully"
          echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # 8. docker-compose.prod.yml íŒŒì¼ EC2ì— ë³µì‚¬
      - name: Copy docker-compose.prod.yml to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: docker-compose.prod.yml
          target: /home/ubuntu/

      # 9. EC2ì— ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          envs: ECR_REGISTRY,ECR_REPOSITORY,IMAGE_TAG,AWS_REGION
          script: |
            set -e

            echo "=== í™˜ê²½ ì¤€ë¹„ ==="
            cd /home/ubuntu

            # ECR ë¡œê·¸ì¸
            echo "ECR ë¡œê·¸ì¸..."
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            echo "í™˜ê²½ë³€ìˆ˜ ì„¤ì •..."
            cat > .env << EOF
            # === ë°ì´í„°ë² ì´ìŠ¤ (RDS) ===
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # === Redis (Docker Container) ===
            REDIS_HOST=redis
            REDIS_PORT=6379

            # === JWT í† í° ===
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_TOKEN_VALIDITY=43200000

            # === AES ì•”í˜¸í™” ===
            AES_SECRET_KEY=${{ secrets.AES_SECRET_KEY }}

            # === ì´ë©”ì¼ ì„œë¹„ìŠ¤ ===
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}

            # === OAuth2 ì†Œì…œ ë¡œê·¸ì¸ ===
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            NAVER_REDIRECT_URI=${{ secrets.NAVER_REDIRECT_URI }}

            # === ê¸°íƒ€ ì„¤ì • ===
            FRONTEND_URL=https://super-lawva.vercel.app
            SERVER_PORT=8080
            SPRING_PROFILES_ACTIVE=prod

            # === Docker ì´ë¯¸ì§€ ì •ë³´ ===
            ECR_REGISTRY=$ECR_REGISTRY
            IMAGE_TAG=$IMAGE_TAG
            EOF

            # .env íŒŒì¼ í™•ì¸ (ë¹„ë°€ë²ˆí˜¸ëŠ” ë§ˆìŠ¤í‚¹)
            echo "=== .env íŒŒì¼ ìƒì„± ì™„ë£Œ ==="
            sed -e 's/PASSWORD=.*/PASSWORD=****/' -e 's/SECRET=.*/SECRET=****/' .env

            echo "=== Docker Compose ë°°í¬ ==="
            # 6379/6380 í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            echo "í¬íŠ¸ 6379/6380 ì •ë¦¬ ì¤‘..."
            sudo fuser -k 6379/tcp || true
            sudo fuser -k 6380/tcp || true
            sudo lsof -ti:6379 | xargs -r sudo kill -9 || true
            sudo lsof -ti:6380 | xargs -r sudo kill -9 || true

            # Redis ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ ì¤‘ì§€ (ìˆë‹¤ë©´)
            sudo systemctl stop redis-server 2>/dev/null || true
            sudo systemctl stop redis 2>/dev/null || true

            # Redis ê´€ë ¨ Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop $(docker ps -q --filter "name=redis") 2>/dev/null || true
            docker rm $(docker ps -aq --filter "name=redis") 2>/dev/null || true

            # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ëª…ë ¹ì–´ ê²°ì •
            if command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
            elif docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              echo "Docker Composeë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              COMPOSE_CMD="docker-compose"
            fi

            echo "ì‚¬ìš©í•  Docker Compose ëª…ë ¹ì–´: $COMPOSE_CMD"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            $COMPOSE_CMD -f docker-compose.prod.yml down || true

            # ìƒˆ ì´ë¯¸ì§€ í’€
            $COMPOSE_CMD -f docker-compose.prod.yml pull app

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
            $COMPOSE_CMD -f docker-compose.prod.yml up -d

            # ë¡œê·¸ í™•ì¸
            echo "=== ë°°í¬ ì™„ë£Œ - ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ ==="
            echo "30ì´ˆê°„ ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§..."
            timeout 30s $COMPOSE_CMD -f docker-compose.prod.yml logs -f app || true

            echo "=== ìµœê·¼ ë¡œê·¸ í™•ì¸ ==="
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=100 app

            # í—¬ìŠ¤ì²´í¬
            echo "=== í—¬ìŠ¤ì²´í¬ ==="
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸:"
            $COMPOSE_CMD -f docker-compose.prod.yml ps

            echo "ë” ë§ì€ ë¡œê·¸ í™•ì¸:"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=100 app

            for i in {1..3}; do
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/3..."
              if curl -f -m 150 http://localhost:8080/auth/health; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
                break
              else
                echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/3)"
                if [ $i -eq 2 ]; then
                  echo "=== ì¤‘ê°„ ë¡œê·¸ í™•ì¸ ($i) ==="
                  $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 app
                fi
                sleep 30
              fi
            done

            # ì •ë¦¬
            echo "=== ì´ë¯¸ì§€ ì •ë¦¬ ==="
            docker system prune -f || true

            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
